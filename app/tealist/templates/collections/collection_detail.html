{% extends "base.html" %}
{% load markdown_extras %}
{% load static %}

{% block content %}

<div class="row">
    <div class="card border shadow-sm mb-3 pt-3 col-md-8 col-12">
        <div class="card-body">
            <div class="card-title d-flex justify-content-between align-items-center">
                <div id="collection-title">
                    <h4 class="mb-0">{{ collection.name }}</h4>
                    <small class="text-muted">By {{ collection.user.username }} on
                        {{ collection.created_on|date:"D, F jS" }}</small>
                </div>
                <a id="collection-rating" class=""
                    {% if user.is_authenticated %}
                    href="{{ collection.get_absolute_url }}rate" hx-target="#rating"
                    hx-post="{{ collection.get_absolute_url }}rate" hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                    data-toggle="tooltip" data-placement="top" title="Like this collection"
                    {% else %}
                    data-toggle="tooltip" data-placement="top" title="Login to like this collection"
                    {% endif %}>
                    <span id="rating" class="d-flex flex-column align-items-center text-white text-center">
                        +{{ collection.rating.all.count }}
                    </span>
                    <div class="rating-img pt-1"></div>

                </a>
            </diV>

            {% if collection.vendors %}
            <ul class="pt-4 pb-4 tea-marker">
                {% for vendor in collection.vendors.all %}
                <li class="border-bottom">
                    <a href="{{ vendor.get_absolute_url }}" hx-get="{{ vendor.get_absolute_url }}"
                        hx-target="#htmx-modal" hx-trigger="click">
                        {{ vendor.name }}
                    </a>
                </li>
                {% endfor %}
            </ul>
            {% endif %}

            <p class="">{{ collection.content|markdown|safe }}<p>
        </div>
    </div>
    <div class="col-md-4 col-12">
        <div class="card border shadow-smmb-3 mb-3">
            <div class="card-body d-flex flex-column align-items-center">
                <img class="rounded-circle img-fluid w-50 account-img pb-3"
                    src="{{ collection.user.profile.image.url }}" />
                <h4 class="mb-0">{{ collection.user.first_name }} {{ collection.user.last_name }}</h4>
                <h6>{{ collection.user.username }}</h6>
                <small class="text-muted">
                    <i class="material-symbols-outlined material-xs">
                        library_books
                    </i> Collections: {{ collection.user.collection_owner.all.count }}
                    <i class="material-symbols-outlined material-xs">
                        calendar_month
                    </i> Joined: {{ collection.user.date_joined|date:"m/d/o" }}

                </small>
            </div>
        </div>
        <div class="card border shadow-smmb-3 mb-3">
            <div id="tea_source_donut" class="card-body text-white">
                <h4 class="pb-3">Vendor sourcing</h4>

            </div>
        </div>

    </div>
</div>

{{ collection.get_location_stats|json_script:"location_data" }}

<script>
    var customData = JSON.parse(JSON.parse((document.getElementById('location_data').textContent)));

    var width = 800,
        height = 450,
        radius = Math.min(width, height) / 2;

    var color = d3.scaleOrdinal()
        .range(["#90ab71", "#5d7740", "#e6f6d1", "#f6edd9", "#8e8455", "#ffd08f", "#cccc7c"]);

    var arc = d3.arc()
        .outerRadius(radius - 10)
        .innerRadius(radius - 100);

    var outerArc = d3.arc()
        .innerRadius(radius * 0.9)
        .outerRadius(radius * 0.9)

    var pie = d3.pie()
        .sort(null)
        .value(function (d) {
            return d.location_count;
        });

    var svg = d3.select("#tea_source_donut")
        .append("svg")
        .attr("viewBox", `0 0 800 450`)
        .attr("class", "test")
        .append("g")
        .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");
    /*
    d3.csv("data.csv", type, function(error, data) {
      if (error) throw error;
    });
    */
    var g = svg.selectAll(".arc")
        .data(pie(customData))
        .enter().append("g")
        .attr("class", "arc");

    g.append("path")
        .attr("d", arc)
        .style("fill", function (d) {
            return color(d.data.name);
        });

    g.append("text")
        .attr("transform", function (d) {
            return "translate(" + arc.centroid(d) + ")";
        })
        .style("fill", "white")
        .attr("dy", ".35em")
        .text(function (d) {
            return d.data.name;
        })
        .attr('transform', function (d) {
            var pos = outerArc.centroid(d);
            var midangle = d.startAngle + (d.endAngle - d.startAngle) / 2
            pos[0] = radius * 0.99 * (midangle < Math.PI ? 1 : -1);
            return 'translate(' + pos + ')';
        })
        .style('text-anchor', function (d) {
            var midangle = d.startAngle + (d.endAngle - d.startAngle) / 2
            return (midangle < Math.PI ? 'start' : 'end')
        })
        .style('font-size', '1.5rem')

    function type(d) {
        d.location_count = +d.location_count;
        return d;
    }

    svg
        .selectAll('allPolylines')
        .data(pie(customData))
        .enter()
        .append('polyline')
        .attr("stroke", "white")
        .style("fill", "none")
        .attr("stroke-width", 1)
        .attr('points', function (d) {
            var posA = arc.centroid(d) // line insertion in the slice
            var posB = outerArc.centroid(
                d) // line break: we use the other arc generator that has been built only for that
            var posC = outerArc.centroid(d); // Label position = almost the same as posB
            var midangle = d.startAngle + (d.endAngle - d.startAngle) /
                2 // we need the angle to see if the X position will be at the extreme right or extreme left
            posC[0] = radius * 0.95 * (midangle < Math.PI ? 1 : -
                1); // multiply by 1 or -1 to put it on the right or on the left
            return [posA, posB, posC]
        })
</script>

{% endblock %}